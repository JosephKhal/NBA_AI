<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA AI</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Include your custom CSS file -->
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
</head>

<body>

    <!--HEADER and NAVBAR-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
                <img src="{{ url_for('static', filename='img/nba_ai_logo.png') }}" alt="NBA AI Logo" width="60"
                    height="60">
                <span class="navbar-text">NBA AI</span>
            </a>
        </div>
    </nav>



    <!--MAIN GAMES TABLE-->
    <div class="container mt-4">
        <div id="noGamesAlert" class="alert alert-info" style="display: none;">No Games for this date.</div>
        <table class="table custom-table">
            <thead>
                <tr>
                    <th rowspan="2"></th> <!-- Placeholder for Time Display -->
                    <th rowspan="2">Home</th>
                    <th rowspan="2">Away</th>
                    <th colspan="2" class="text-center">Current Score</th>
                    <th colspan="2" class="text-center">Predicted Score</th>
                    <th rowspan="2" class="text-center">Predicted Winner</th>
                </tr>
                <tr>
                    <!-- Subheaders for Current Score -->
                    <th class="text-center">Home</th>
                    <th class="text-center">Away</th>

                    <!-- Subheaders for Predicted Score -->
                    <th class="text-center">Home</th>
                    <th class="text-center">Away</th>
                </tr>
            </thead>
            <tbody id="gamesTableBody">
                <!-- Games will be loaded here dynamically -->
            </tbody>
        </table>
    </div>


    <!-- Simplified Pagination Controls -->
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item">
                <a class="page-link" href="/?date={{ prev_date }}">&lt;&lt;</a>
            </li>
            <li class="page-item active">
                <span class="page-link">{{ query_date_display_str }}</span>
            </li>
            <li class="page-item">
                <a class="page-link" href="/?date={{ next_date }}">&gt;&gt;</a>
            </li>
        </ul>
    </nav>

    <!-- GAME DETAILS MODAL -->
    <div class="modal fade" id="gameDetailsModal" tabindex="-1" aria-labelledby="gameDetailsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- Change modal-dialog class to modal-xl -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gameDetailsModalLabel">Game Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Game details will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Template for Game Details Modal Body -->
    <template id="gameDetailsTemplate">
        <div class="row flex-column-reverse flex-lg-row">
            <!-- Play By Play -->
            <div class="col-lg-5 overflow-auto" style="max-height: 500px;" id="play_by_play">
                <table class="table">
                    <thead>
                        <tr>
                            <th colspan="2">Play By Play</th>
                            <th id="homeTeamHeader">Home</th>
                            <th id="awayTeamHeader">Away</th>
                        </tr>
                    </thead>
                    <tbody id="playByPlayBody">
                        <!-- Dynamic play-by-play rows will be added here -->
                    </tbody>
                </table>
            </div>

            <!-- Live Predictions -->
            <div class="col-lg-7" id="live_predictions">
                <div class="row justify-content-center mb-2 border-bottom" id="live_predictions_title"
                    style="border-color: lightgrey;">
                    <div class="col">
                        <h1 class="text-center">Live Predictions</h1>
                    </div>
                </div>
                <div class="row mb-4 border-bottom" style="border-color: lightgrey;">
                    <div class="col">
                        <div class="row align-items-center">
                            <div class="col-6 text-center d-flex flex-column justify-content-center">
                                <h4 id="templateHomeTeam"></h4>
                                <h1 class="mb-0" id="templatePredictedHomeScore"></h1>
                            </div>
                            <div class="col-6 d-flex align-items-center justify-content-center">
                                <img id="templateHomeLogo" src="" alt="Team Logo" class="img-fluid"
                                    style="max-width: 100px;">
                            </div>
                        </div>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center">
                        <div class="row">
                            <div class="col text-center d-flex justify-content-center align-items-center">
                                <!-- Left SVG icon -->
                                <i class="bi bi-caret-left-fill me-0 text-success" id="winnerLeftIcon"
                                    style="visibility: hidden; font-size: 2rem;"></i>
                                <!-- Winner Text and Percentage -->
                                <div>
                                    <h5 class="mb-0">Winner</h5>
                                    <h4 id="templatePredictedWinPct" class="mb-0"></h4>
                                </div>

                                <!-- Right SVG icon -->
                                <i class="bi bi-caret-right-fill ms-0 text-success" id="winnerRightIcon"
                                    style="visibility: hidden; font-size: 2rem;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="row align-items-center">
                            <div class="col-6 d-flex align-items-center justify-content-center">
                                <img id="templateAwayLogo" src="" alt="Team Logo" class="img-fluid"
                                    style="max-width: 100px;">
                            </div>
                            <div class="col-6 text-center d-flex flex-column justify-content-center">
                                <h4 id="templateAwayTeam"></h4>
                                <h1 class="mb-0" id="templatePredictedAwayScore"></h1>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Container for Player Information (third row in the right column) -->
                <div class="row" id="playerInfoContainer">
                    <!-- Home Team Players -->
                    <div class="col-1"></div>
                    <div class="col-5 d-flex justify-content-center flex-column" id="homeTeamPlayers">
                        <!-- Dynamic home team players will be added here -->
                    </div>

                    <!-- Road Team Players -->
                    <div class="col-1"></div>
                    <div class="col-5 d-flex justify-content-center flex-column" id="roadTeamPlayers">
                        <!-- Dynamic road team players will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </template>




    <!-- Bootstrap 5 JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function fetchAndUpdateGames() {
                const queryDate = "{{ query_date_str }}";
                fetch(`/get-games?date=${queryDate}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(games => {
                        const tableBody = document.querySelector('#gamesTableBody');
                        tableBody.innerHTML = '';

                        if (games.length > 0) {
                            games.forEach(game => {
                                console.log('Game:', game);
                                const row = document.createElement('tr');
                                row.className = 'game-row';
                                row.setAttribute('data-game-id', game.game_id);
                                row.innerHTML = `
                                    <td class="text-left" style="vertical-align: middle;">${(game.time_display).split('-').join('<br>')}</td>
                                    <td style="vertical-align: middle;">
                                        <div style="display: flex; align-items: center;">
                                            <img src="${game.home_logo_url}" alt="Logo of ${game.home_team_display}" style="width: 50px; height: auto; margin-right: 10px;">
                                            <div style="text-align: left;">${game.home_team_display}</div>
                                        </div>
                                    </td>
                                    <td style="vertical-align: middle;">
                                        <div style="display: flex; align-items: center;">
                                            <img src="${game.away_logo_url}" alt="Logo of ${game.away_team_display}" style="width: 50px; height: auto; margin-right: 10px;">
                                            <div style="text-align: left;">${game.away_team_display}</div>
                                        </div>
                                    </td>
                                    <td class="text-center" style="vertical-align: middle;">${game.home_score}</td>
                                    <td class="text-center" style="vertical-align: middle;">${game.away_score}</td>
                                    <td class="text-center" style="vertical-align: middle;">${game.predictions.home_score}</td>
                                    <td class="text-center" style="vertical-align: middle;">${game.predictions.away_score}</td>
                                    <td class="text-center" style="vertical-align: middle;">${game.predictions.winning_team} ${game.predictions.winning_team_pct}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No Games for the selected date</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching games:', error);
                    });
            }

            fetchAndUpdateGames();
        });
    </script>


    <!-- Custom JS to fetch and display game details -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function populatePlayerDetails(players, container, limit = 5) {
                container.innerHTML = ''; // Clear previous content

                // Loop through player details
                for (let i = 0; i < players.length; i++) {
                    if (i >= limit) {
                        break; // Break the loop when the limit is reached
                    }

                    const player = players[i];

                    if (player.name) { // If player data exists
                        const playerDetailDiv = document.createElement('div');
                        playerDetailDiv.className = 'player-detail row d-flex align-items-center mb-3';
                        playerDetailDiv.innerHTML = `
                        <div class="col-auto">
                            <img src="${player.player_headshot_url}" alt="${player.name}" class="img-fluid mb-2" style="width: 80px; height: auto;">
                        </div>
                        <div class="col">
                            <p class="mb-0"><strong>${player.name}</strong></p>
                            <p class="mb-0">${player.predicted_points} PTS</p>
                        </div>
                        `;

                        container.appendChild(playerDetailDiv);
                    }
                }
            }

            function populatePlayByPlay(home_team, away_team, pbp, limit = 10) {
                const homeTeamHeader = document.getElementById('homeTeamHeader');
                const awayTeamHeader = document.getElementById('awayTeamHeader');
                const playByPlayBody = document.getElementById('playByPlayBody');

                // Set team names in headers
                homeTeamHeader.textContent = home_team;
                awayTeamHeader.textContent = away_team;

                // Clear existing content
                playByPlayBody.innerHTML = '';

                // Check if pbp array is empty
                if (pbp.length === 0) {
                    playByPlayBody.innerHTML = '<tr><td colspan="4" class="text-center">No Play By Play Logs Available</td></tr>';
                } else {
                    // Add rows to the table, adjusting for the updated structure
                    pbp.slice(0, limit).forEach((record) => {
                        const formattedTime = record.time_info;
                        const description = record.description;
                        const homeScore = record.home_score;
                        const awayScore = record.away_score;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formattedTime}</td>
                            <td>${description}</td>
                            <td>${homeScore}</td>
                            <td>${awayScore}</td>
                        `;
                        playByPlayBody.appendChild(row);
                    });
                }
            }


            function showGameDetails(gameId) {
                fetch(`/game-details/${gameId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Game details:', data);
                        const home = data.home;
                        const away = data.away;
                        const homeFullName = data.home_full_name;
                        const awayFullName = data.away_full_name;
                        const homeLogoUrl = data.home_logo_url;
                        const awayLogoUrl = data.away_logo_url;
                        const homeScore = data.home_score;
                        const awayScore = data.away_score;
                        const timeDisplay = data.time_display;
                        const playByPlay = data.pbp;
                        const homePlayers = data.home_players;
                        const roadPlayers = data.away_players;

                        // Construct the modal header content
                        const modalTitle = document.querySelector('#gameDetailsModalLabel');
                        modalTitle.innerHTML = `
                            ${homeFullName} <img src="${homeLogoUrl}" alt="${homeFullName}" style="width: 30px; height: auto;"> 
                            ${homeScore} - ${awayScore} 
                            <img src="${awayLogoUrl}" alt="${awayFullName}" style="width: 30px; height: auto;"> ${awayFullName} 
                            <span class="breakpoint"> - <wbr></span>${timeDisplay}
                            <style>
                                @media (max-width: 600px) {
                                    .breakpoint {
                                        display: none;
                                    }
                                }
                            </style>
                        `;

                        // Use the template for the modal body
                        const template = document.querySelector('#gameDetailsTemplate').content.cloneNode(true);
                        template.querySelector('#templateHomeTeam').textContent += `${home}`;
                        template.querySelector('#templateAwayTeam').textContent += `${away}`;
                        template.querySelector('#templateHomeLogo').src = homeLogoUrl;
                        template.querySelector('#templateAwayLogo').src = awayLogoUrl;
                        template.querySelector('#templatePredictedHomeScore').textContent += `${data.predictions.home_score}`;
                        template.querySelector('#templatePredictedAwayScore').textContent += `${data.predictions.away_score}`;
                        template.querySelector('#templatePredictedWinPct').textContent += `${data.predictions.winning_team_pct}`;

                        // Populate player details for both teams
                        const homePlayersContainer = template.querySelector('#homeTeamPlayers');
                        const roadPlayersContainer = template.querySelector('#roadTeamPlayers');
                        populatePlayerDetails(homePlayers, homePlayersContainer);
                        populatePlayerDetails(roadPlayers, roadPlayersContainer);

                        const modalBody = document.querySelector('#gameDetailsModal .modal-body');
                        modalBody.innerHTML = ''; // Clear existing content
                        modalBody.appendChild(template);

                        // Determine which icon to show based on the predicted winner
                        const winnerLeftIcon = document.getElementById('winnerLeftIcon');
                        const winnerRightIcon = document.getElementById('winnerRightIcon');

                        if (data.predictions.winning_team === data.home) {
                            winnerLeftIcon.style.visibility = 'visible';
                            winnerRightIcon.style.visibility = 'hidden';
                        } else if (data.predictions.winning_team === data.away) {
                            winnerRightIcon.style.visibility = 'visible';
                            winnerLeftIcon.style.visibility = 'hidden';
                        } else {
                            winnerLeftIcon.style.visibility = 'hidden';
                            winnerRightIcon.style.visibility = 'hidden';
                        }

                        populatePlayByPlay(home, away, playByPlay, 100);

                        // Show the modal
                        var gameDetailsModal = new bootstrap.Modal(document.getElementById('gameDetailsModal'), {});
                        gameDetailsModal.show();
                    })
                    .catch(error => {
                        console.error('Error fetching game details:', error);
                    });
            }

            const tableBody = document.querySelector('#gamesTableBody');
            tableBody.addEventListener('click', function (event) {
                let target = event.target;
                while (target != null && !target.classList.contains('game-row')) {
                    target = target.parentElement;
                }

                if (target && target.classList.contains('game-row')) {
                    const gameId = target.getAttribute('data-game-id');
                    showGameDetails(gameId);
                }
            });
        });
    </script>





</body>


</html>